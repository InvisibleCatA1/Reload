package com.invisiblecat.reload.module.modules.exploit;

import com.invisiblecat.reload.event.EventTarget;
import com.invisiblecat.reload.event.events.EventPreMotionUpdate;
import com.invisiblecat.reload.event.events.EventRecivePacket;
import com.invisiblecat.reload.event.events.EventSendPacket;
import com.invisiblecat.reload.event.events.EventUpdate;
import com.invisiblecat.reload.module.Category;
import com.invisiblecat.reload.module.Module;
import com.invisiblecat.reload.setting.settings.ModeSetting;
import com.invisiblecat.reload.utils.PacketUtils;
import com.invisiblecat.reload.utils.TimerUtils;
import net.minecraft.client.entity.EntityPlayerSP;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.*;
import net.minecraft.network.play.server.S08PacketPlayerPosLook;

import java.util.Queue;
import java.util.UUID;
import java.util.concurrent.ConcurrentLinkedDeque;

public class Disabler extends Module {

    private final TimerUtils lagDelay = new TimerUtils();
    private final Queue<Packet<?>> packets = new ConcurrentLinkedDeque<>();
    private boolean tped;

    private int count = 0;
    private int count1 = 0;

    private final ModeSetting mode = new ModeSetting("Mode", "Blocks MC", "Blocks MC", "Mineplex Combat", "Blocks MC Movement");


    public Disabler() {
        super("Disabler", 0, Category.EXPLOIT, AutoDisable.NONE);
        this.addSettings(mode);
    }

    @Override
    public void onDisable() {
        super.onDisable();
        packets.clear();
    }

    @EventTarget
    public void onUpdate(EventUpdate event) {
        this.setDisplayName(mode.getSelected());
    }

    @EventTarget
    public void onRecivePacket(EventRecivePacket event) {
        Packet<?> packet = event.getPacket();

        switch (mode.getSelected().toLowerCase().replaceAll("\\s", "")) {
            case "blocksmc":
                if (packet instanceof S08PacketPlayerPosLook && lagDelay.hasTimePassed(1000, true)) {
                    final S08PacketPlayerPosLook s08 = (S08PacketPlayerPosLook) packet;
                    if (mc.thePlayer.getDistanceSq(s08.getX(), s08.getY(), s08.getZ()) <= 9.5) {
                        PacketUtils.sendPacketNoEvent(new C03PacketPlayer.C06PacketPlayerPosLook(s08.getX(), s08.getY(), s08.getZ(), s08.getYaw(), s08.getPitch(), false));
                        event.setCancelled(true);
                    }
                }
        }
    }

    @EventTarget
    public void onSendPacket(EventSendPacket event) {
        Packet packet = event.getPacket();

        switch (mode.getSelected().toLowerCase().replaceAll("\\s", "")) {
            case "blocksmc":
                if (packet instanceof C0BPacketEntityAction) {
                    C0BPacketEntityAction action = (C0BPacketEntityAction) packet;
                    if (action.getAction() == C0BPacketEntityAction.Action.START_SPRINTING) {
                        if (EntityPlayerSP.serverSprintState) {
                            PacketUtils.sendPacketNoEvent(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.STOP_SPRINTING));
                            EntityPlayerSP.serverSprintState = false;
                        }
                        event.setCancelled(true);
                    }
                    if (action.getAction() == C0BPacketEntityAction.Action.STOP_SPRINTING) {
                        event.setCancelled(true);
                    }
                }

                if (packet instanceof C00PacketKeepAlive || packet instanceof C0FPacketConfirmTransaction) {
                    event.setCancelled(true);
                    if (packet instanceof C00PacketKeepAlive) {
                        C00PacketKeepAlive keepAlive = (C00PacketKeepAlive) packet;
                        keepAlive.setKey(-keepAlive.getKey());
                    }
                    packets.add(packet);

                    if (packets.size() > 300) {
                        PacketUtils.sendPacketNoEvent(packets.poll());
                    }
                }
                if (packet instanceof C03PacketPlayer) {
                    final C03PacketPlayer c03 = (C03PacketPlayer) packet;


                    if (mc.thePlayer.ticksExisted % 20 == 0) {
                        PacketUtils.sendPacketNoEvent(new C18PacketSpectate(UUID.randomUUID()));
                        PacketUtils.sendPacketNoEvent(new C0CPacketInput(0.98F, 0.98F, false, false));
                    }

                    if (mc.thePlayer.ticksExisted % 120 == 0) {
                        c03.setOnGround(false);
                    }
                    if (c03.getPositionY() % 0.015625 == 0)
                        c03.setOnGround(true);
                }

                

        }

    }

    @EventTarget
    public void onPreMotion(EventPreMotionUpdate event) {
        if (mc.isIntegratedServerRunning()) return;

        if (mode.getSelected().toLowerCase().replaceAll("\\s", "").equals("blocksmc")) {
            C13PacketPlayerAbilities abilities = new C13PacketPlayerAbilities();
            if (lagDelay.hasTimePassed(490L, true)) {

                if(!packets.isEmpty()) {
                    PacketUtils.sendPacketNoEvent(packets.poll());
                }
            }

            abilities.setAllowFlying(true);
            abilities.setFlying(true);

            PacketUtils.sendPacketNoEvent(abilities);
        }
    }
}

